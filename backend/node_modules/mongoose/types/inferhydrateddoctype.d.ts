import express from "express";
import mongoose from "mongoose";
import cors from "cors";
import dotenv from "dotenv";
import Doctor from "./models/Doctor.js";
import Patient from "./models/Patient.js";
import Consultation from "./models/Consultation.js";
import Prescription from "./models/Prescription.js";
import { PDFDocument, StandardFonts } from "pdf-lib";

dotenv.config();
const app = express();
app.use(cors());
app.use(express.json());

mongoose.connect(process.env.MONGO_URL)
  .then(() => console.log("MongoDB Connected"));

/* ---------- AUTH ---------- */
app.post("/doctor/signup", async (req, res) => {
  res.json(await Doctor.create(req.body));
});

app.post("/patient/signup", async (req, res) => {
  req.body.illnessHistory = req.body.illnessHistory.split(",");
  res.json(await Patient.create(req.body));
});

/* ---------- DOCTOR LIST ---------- */
app.get("/doctors", async (_, res) => {
  res.json(await Doctor.find());
});

/* ---------- CONSULTATION ---------- */
app.post("/consultation", async (req, res) => {
  res.json(await Consultation.create(req.body));
});

app.get("/doctor/consultations/:doctorId", async (req, res) => {
  res.json(await Consultation.find({ doctorId: req.params.doctorId }));
});

/* ---------- PRESCRIPTION ---------- */
app.post("/prescription/:consultationId", async (req, res) => {
  const { care, medicine } = req.body;

  const pdf = await PDFDocument.create();
  const page = pdf.addPage([600, 800]);
  const font = await pdf.embedFont(StandardFonts.Helvetica);

  page.drawText("Prescription", { x: 230, y: 760, size: 20, font });
  page.drawText("Care to be taken:", { x: 50, y: 700 });
  page.drawText(care, { x: 50, y: 670 });
  page.drawText("Medicine:", { x: 50, y: 600 });
  page.drawText(medicine || "-", { x: 50, y: 570 });

  const pdfBytes = await pdf.save();

  const saved = await Prescription.findOneAndUpdate(
    { consultationId: req.params.consultationId },
    { care, medicine, pdfData: pdfBytes },
    { upsert: true, new: true }
  );

  res.json({ message: "Prescription saved", id: saved._id });
});

app.get("/prescription/pdf/:id", async (req, res) => {
  const p = await Prescription.findById(req.params.id);
  res.setHeader("Content-Type", "application/pdf");
  res.send(p.pdfData);
});

app.listen(5000, () => console.log("Server running on 5000"));
